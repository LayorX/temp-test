<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 女神製造所 v6.3 (終極浪漫版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0c0a18;
            color: #F3F4F6;
            overflow-x: hidden;
        }
        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        /* --- Loading Overlay --- */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(2,0,36,1) 0%, rgba(12,10,24,1) 35%, rgba(46,16,49,1) 100%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 1s ease-out;
            opacity: 1;
        }
        #loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #loading-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }
        #loading-content {
            z-index: 10;
            text-align: center;
            color: white;
            text-shadow: 0 0 15px rgba(236, 72, 153, 0.7);
        }
        #loading-silhouette {
            height: 40vh;
            max-height: 400px;
            margin-bottom: 2rem;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
        }
        #loading-silhouette.visible {
            opacity: 0.5;
        }
        .main-container {
            position: relative;
            z-index: 10;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: rgba(12, 10, 24, 0.8);
            backdrop-filter: blur(12px);
            padding-top: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            padding-top: 1.5rem;
        }
        .image-card {
            background-color: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            aspect-ratio: 2 / 3;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.8s ease-out forwards;
            opacity: 0;
            position: relative;
            transform-style: preserve-3d;
        }
        .image-card .flipper {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .image-card.reveal .flipper {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .image-card-img-wrapper {
            width: 100%;
            height: 100%;
            cursor: pointer;
            overflow: hidden;
        }
        .image-card-img-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        .image-card:hover .image-card-img-wrapper img {
            transform: scale(1.05);
        }
        .card-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 0.75rem;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .story-btn {
            background-color: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.875rem;
        }
        .story-btn:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
        .like-btn {
            background: none;
            border: none;
            font-size: 1.75rem;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            transition: transform 0.2s ease, color 0.2s ease;
            text-shadow: 0 0 5px black;
        }
        .like-btn:hover {
            transform: scale(1.2);
        }
        .like-btn.liked {
            color: #ef4444;
            transform: scale(1.1);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-base {
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.4);
            animation: pulse-glow 2s infinite alternate;
        }
        .btn-primary {
             background: linear-gradient(45deg, #EC4899, #8B5CF6);
        }
        .btn-secondary {
            background: linear-gradient(45deg, #4f46e5, #8b5cf6);
        }
        .btn-base:hover {
            transform: scale(1.05);
        }
        .btn-base:disabled {
            background: #4B5563;
            cursor: not-allowed;
            transform: scale(1);
            box-shadow: none;
            animation: none;
        }
        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid #4B5563;
            border-bottom-color: #EC4899;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #EC4899;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 3100;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        #message-box.show { opacity: 1; transform: translateY(0); }
        .tab-button {
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active { color: #EC4899; border-bottom-color: #EC4899; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        
        .model-selector {
            background-color: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            color: #F3F4F6;
        }
        .model-selector:focus {
            outline: none;
            box-shadow: 0 0 0 2px #8B5CF6;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transform: scale(0.8);
            transition: transform 0.3s ease;
            max-width: 90vw;
            max-height: 90vh;
        }
        .modal.show .modal-content {
            transform: scale(1);
        }
        #image-modal-content img {
            border-radius: 0.5rem;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.2);
        }
        #story-modal-content {
            background-color: rgba(12, 10, 24, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 2rem;
            width: 90vw;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            color: #E5E7EB;
        }
        
        /* Slideshow Modal */
        #slideshow-modal {
            z-index: 3000;
            background-color: #000;
            flex-direction: column;
        }
        #slideshow-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            flex-grow: 1;
        }
        #slideshow-image {
            max-width: 100vw;
            max-height: calc(100vh - 120px);
            object-fit: contain;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #slideshow-image.visible {
            opacity: 1;
        }
        .slideshow-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            font-size: 2rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            border-radius: 0.5rem;
        }
        .slideshow-nav:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }
        #slideshow-prev { left: 1rem; }
        #slideshow-next { right: 1rem; }
        #slideshow-top-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 1rem;
        }
        .slideshow-control-btn {
            background-color: rgba(255, 255, 255, 0.2);
            font-size: 1.5rem;
            padding: 0.5rem;
            width: 44px;
            height: 44px;
            border-radius: 50%;
        }
        #thumbnail-bar {
            width: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 0.5rem;
            text-align: center;
            overflow-x: auto;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .thumbnail {
            width: 60px;
            height: 90px;
            object-fit: cover;
            border-radius: 0.25rem;
            border: 2px solid transparent;
            cursor: pointer;
            display: inline-block;
            margin: 0 0.25rem;
            transition: border-color 0.3s;
        }
        .thumbnail.active {
            border-color: #EC4899;
            box-shadow: 0 0 10px #EC4899;
        }
        #favorites-empty-state {
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            height: 100%;
        }
    </style>
</head>
<body>
    <canvas id="background-canvas"></canvas>

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <canvas id="loading-canvas"></canvas>
        <div id="loading-content">
             <img id="loading-silhouette" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAoAAAAKACAYAAABn90xIAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAXwSURBVHja7d1BDQAgEMCw9/8/9hBFEaQ1EwEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAwAIBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQE...BAg/IAAAA4AIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAAIAAAACAA...AAA=" alt="女神剪影">
            <h2 id="loading-text" class="text-2xl font-bold text-gray-300 mb-4">喚醒沉睡的繆斯...</h2>
        </div>
    </div>

    <!-- Modals -->
    <div id="image-modal" class="modal">
        <div id="image-modal-content" class="modal-content"><img id="modal-image" src="" alt="放大預覽"></div>
    </div>
    <div id="story-modal" class="modal">
        <div id="story-modal-content" class="modal-content">
            <h2 class="text-2xl font-bold text-center mb-4 bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500">女神的篇章</h2>
            <div id="story-text" class="text-lg leading-relaxed mb-6 min-h-[100px]"></div>
            <div class="text-center"><button id="tts-btn" class="btn-generate text-white font-bold py-2 px-6 rounded-full">聆聽故事</button></div>
        </div>
    </div>
    <div id="slideshow-modal" class="modal">
        <div id="slideshow-container">
            <img id="slideshow-image" src="">
            <button id="slideshow-prev" class="slideshow-nav">&lt;</button>
            <button id="slideshow-next" class="slideshow-nav">&gt;</button>
            <div id="slideshow-top-controls">
                <button id="slideshow-unfavorite" class="slideshow-control-btn">💔</button>
                <button id="slideshow-close" class="slideshow-control-btn">&times;</button>
            </div>
        </div>
        <div id="thumbnail-bar">
             <div id="favorites-empty-state">
                <p class="text-2xl mb-4">💔</p>
                <p>殿堂還是空的</p>
                <p class="text-sm text-gray-500">快去收藏您心儀的女神吧！</p>
            </div>
        </div>
    </div>
    
    <audio id="tts-audio"></audio>

    <div class="main-container">
        <header class="sticky-header">
            <div class="container mx-auto px-4">
                <div class="text-center">
                    <h1 class="text-3xl md:text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500 mb-2">
                        AI 女神製造所 6.2
                    </h1>
                </div>
                <div class="flex flex-col md:flex-row justify-center items-center gap-4 my-4">
                    <div class="flex items-center gap-2">
                        <label for="model-select" class="text-md text-gray-300">AI 圖片模型:</label>
                        <select id="model-select" class="model-selector">
                            <option value="gemini-flash">Gemini Flash (推薦)</option>
                            <option value="imagen-3">Imagen 3 (高品質)</option>
                        </select>
                    </div>
                    <button id="generate-one-btn" class="btn-base btn-primary text-white font-bold py-2 px-6 rounded-full text-lg">遇見一位</button>
                    <button id="generate-four-btn" class="btn-base btn-secondary text-white font-bold py-2 px-6 rounded-full text-lg">遇見四位</button>
                    <button id="favorites-btn" class="btn-base btn-primary text-white font-bold py-2 px-6 rounded-full text-lg">女神殿堂 ❤️ <span id="favorites-count">0</span></button>
                </div>
                <nav id="tab-navigation" class="flex justify-center border-b border-gray-700"></nav>
            </div>
        </header>
        
        <main id="style-sections" class="container mx-auto px-4"></main>
    </div>
    
    <div id="message-box"></div>

    <script>
        // --- Global Scope & Constants ---
        const apiKey = "AIzaSyBasaBU3srwcOqVQoyT7uZmtXPa4NRi6gU";
        const styles = [
            { id: 'beach-silhouette', title: '🏖️ 沙灘剪影', description: '黃昏、唯美、充滿想像的浪漫詩篇', prompt: "A beautiful Asian model as a silhouette against a sunset on a deserted beach. She wears a light, semi-transparent white dress. The mood is romantic and beautiful." },
            { id: 'morning-lazy', title: '☀️ 晨光私房', description: '慵懶、私密、屬於你的女友感瞬間', prompt: "A sexy and curvy Asian model with a lazy aura on a messy bed. She wears an oversized men's shirt, unbuttoned, with black stockings. Morning sun streams through blinds, creating a soft, intimate, and seductive atmosphere." },
            { id: 'neon-noir', title: '💦 濕身惡女', description: '霓虹、慾望、無法抗拒的危險魅力', prompt: "A tall, wild, and seductive Asian model in a white shirt caught in a city alley downpour, against a backdrop of blurry neon lights. Her eyes are defiant and confident." },
            { id: 'cyberpunk-warrior', title: '🤖 賽博龐克戰姬', description: '未來、科技、堅毅眼神中的致命吸引力', prompt: "Cyberpunk style. A female Asian warrior in glowing mechanical armor, holding an energy sword. The background is a futuristic city with flying vehicles and towering skyscrapers." }
        ];
        const randomKeywords = {
            hair: ['platinum blonde hair', 'long wavy brown hair', 'short pink hair', 'silver bob cut', 'fiery red braids'],
            outfit: ['in a leather jacket', 'wearing a silk gown', 'in a futuristic jumpsuit', 'wearing a traditional kimono', 'in a simple t-shirt and jeans'],
            setting: ['in a neon-lit tokyo street', 'in a lush green forest', 'on a rooftop overlooking the city', 'inside a cozy cafe', 'in a baroque-style room'],
            artStyle: ['cinematic lighting', 'fantasy art style', 'oil painting style', 'vaporwave aesthetic', 'dramatic lighting']
        };

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const loadingSilhouette = document.getElementById('loading-silhouette');
        const tabNavigation = document.getElementById('tab-navigation');
        const styleSectionsContainer = document.getElementById('style-sections');
        const messageBox = document.getElementById('message-box');
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');
        const storyModal = document.getElementById('story-modal');
        const storyTextEl = document.getElementById('story-text');
        const ttsBtn = document.getElementById('tts-btn');
        const ttsAudio = document.getElementById('tts-audio');
        const generateOneBtn = document.getElementById('generate-one-btn');
        const generateFourBtn = document.getElementById('generate-four-btn');
        const favoritesBtn = document.getElementById('favorites-btn');
        const favoritesCountEl = document.getElementById('favorites-count');
        const slideshowModal = document.getElementById('slideshow-modal');
        const slideshowImage = document.getElementById('slideshow-image');
        const thumbnailBar = document.getElementById('thumbnail-bar');

        // --- State Management ---
        let isGenerating = false;
        let activeStyleId = styles[0].id;
        let isStoryGenerating = false;
        let isTtsGenerating = false;
        let favorites = [];
        let currentSlideshowIndex = 0;
        
        // --- Sound Engine ---
        const sounds = {
            mainSynth: new Tone.Synth().toDestination(),
            fmSynth: new Tone.FMSynth().toDestination(),
            tabSynth: new Tone.Synth().toDestination(),
            start: () => sounds.fmSynth.triggerAttackRelease("C2", "8n"),
            success: () => {
                sounds.mainSynth.triggerAttackRelease("C5", "16n", Tone.now());
                sounds.mainSynth.triggerAttackRelease("E5", "16n", Tone.now() + 0.1);
            },
            tab: () => sounds.tabSynth.triggerAttackRelease("C4", "32n"),
            open: () => sounds.fmSynth.triggerAttackRelease("A3", "16n"),
            like: () => sounds.mainSynth.triggerAttackRelease("A5", "32n"),
        };

        // --- Core Functions ---
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.style.backgroundColor = isError ? '#E11D48' : '#EC4899';
            messageBox.classList.add('show');
            setTimeout(() => messageBox.classList.remove('show'), 3000);
        }

        function initializeUI() {
            generateOneBtn.disabled = true;
            generateFourBtn.disabled = true;
            styles.forEach((style, index) => {
                const tabButton = document.createElement('button');
                tabButton.className = `tab-button text-md font-medium py-2 px-4 text-gray-400 ${index === 0 ? 'active' : ''}`;
                tabButton.textContent = style.title;
                tabButton.dataset.target = `content-${style.id}`;
                tabButton.dataset.styleId = style.id;
                tabNavigation.appendChild(tabButton);

                const section = document.createElement('section');
                section.id = `content-${style.id}`;
                section.className = `tab-content ${index === 0 ? 'active' : ''}`;
                section.innerHTML = `
                    <div class="text-center mb-8 mt-4">
                        <p class="text-gray-400 mt-1">${style.description}</p>
                    </div>
                    <div id="${style.id}-gallery" class="card-container mb-8"></div>
                `;
                styleSectionsContainer.appendChild(section);
            });
            
            addEventListeners();
            loadFavorites();
            generateInitialImages();
        }

        function addEventListeners() {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    sounds.tab();
                    activeStyleId = button.dataset.styleId;
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(button.dataset.target).classList.add('active');
                });
            });

            imageModal.addEventListener('click', () => imageModal.classList.remove('show'));
            storyModal.addEventListener('click', (e) => { if (e.target === storyModal) storyModal.classList.remove('show'); });
            generateOneBtn.addEventListener('click', () => handleImageGeneration(1));
            generateFourBtn.addEventListener('click', () => handleImageGeneration(4));
            favoritesBtn.addEventListener('click', openSlideshow);

            document.getElementById('slideshow-close').addEventListener('click', () => slideshowModal.classList.remove('show'));
            document.getElementById('slideshow-unfavorite').addEventListener('click', unfavoriteCurrentSlide);
            document.getElementById('slideshow-next').addEventListener('click', () => navigateSlideshow(1));
            document.getElementById('slideshow-prev').addEventListener('click', () => navigateSlideshow(-1));
            document.addEventListener('keydown', (e) => {
                if (slideshowModal.classList.contains('show')) {
                    if (e.key === 'ArrowRight') navigateSlideshow(1);
                    if (e.key === 'ArrowLeft') navigateSlideshow(-1);
                    if (e.key === 'Escape') slideshowModal.classList.remove('show');
                }
            });
            
            const slider = document.getElementById('slideshow-container');
            if (slider) {
                let touchstartX = 0;
                let touchendX = 0;
                slider.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, { passive: true });
                slider.addEventListener('touchend', e => {
                    touchendX = e.changedTouches[0].screenX;
                    if (touchendX < touchstartX - 50) navigateSlideshow(1);
                    if (touchendX > touchstartX + 50) navigateSlideshow(-1);
                }, { passive: true });
            }
        }
        
        async function generateInitialImages() {
            loadingSilhouette.classList.add('visible');
            for (let i = 0; i < styles.length; i++) {
                const style = styles[i];
                loadingText.textContent = `正在遇見第 ${i + 1} 位女神... (${style.title})`;
                try {
                    const imageUrl = await generateImageWithRetry(style.prompt);
                    const gallery = document.getElementById(`${style.id}-gallery`);
                    const imageCard = createImageCard({ src: imageUrl, style: style, id: generateUniqueId() });
                    gallery.appendChild(imageCard);
                } catch(error) {
                    console.error(`初始化圖片失敗 (${style.title}):`, error);
                    showMessage(`初始化 ${style.title} 失敗`, true);
                } finally {
                    if (i < styles.length - 1) {
                         await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            }
            
            loadingText.textContent = '邂逅即將開始...';
            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
                generateOneBtn.disabled = false;
                generateFourBtn.disabled = false;
            }, 1000);
        }

        function createImageCard(imageData) {
            const { src, style, id } = imageData;
            const imageCard = document.createElement('div');
            imageCard.className = 'image-card';
            imageCard.dataset.id = id;

            const isLiked = favorites.some(fav => fav.id === id);

            imageCard.innerHTML = `
                <div class="flipper">
                    <div class="card-face card-front">
                         <div class="loader"></div>
                    </div>
                    <div class="card-face card-back">
                        <div class="image-card-img-wrapper">
                            <img src="${src}" alt="${style.title} AI 生成圖片" onerror="this.closest('.image-card').innerHTML = '<p class=\\'text-red-400\\'>圖片載入失敗</p>';">
                        </div>
                        <div class="card-footer">
                             <button class="story-btn">生成故事 ✨</button>
                             <button class="like-btn ${isLiked ? 'liked' : ''}">♥</button>
                        </div>
                    </div>
                </div>
            `;

            const img = imageCard.querySelector('img');
            const cardFront = imageCard.querySelector('.card-front');
            
            img.onload = () => {
                cardFront.style.display = 'none';
                imageCard.classList.add('reveal');
            };
            img.onerror = () => {
                 imageCard.querySelector('.flipper').innerHTML = '<p class="text-red-400 p-4 text-center">圖片載入失敗</p>';
            };

            imageCard.querySelector('.image-card-img-wrapper').addEventListener('click', () => {
                modalImage.src = src;
                imageModal.classList.add('show');
            });
            imageCard.querySelector('.story-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                handleStoryGeneration(style);
            });
            imageCard.querySelector('.like-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(imageData, e.currentTarget);
            });
            return imageCard;
        }

        async function handleImageGeneration(count = 1) {
            if (isGenerating) return;
            sounds.start();
            isGenerating = true;
            generateOneBtn.disabled = true;
            generateFourBtn.disabled = true;
            
            const style = styles.find(s => s.id === activeStyleId);
            const gallery = document.getElementById(`${style.id}-gallery`);
            
            const loadingCards = Array.from({ length: count }, () => {
                const card = document.createElement('div');
                card.className = 'image-card !cursor-default';
                card.style.opacity = '1';
                card.innerHTML = `<div class="loader"></div><p class="text-gray-400">女神降臨中...</p>`;
                gallery.prepend(card);
                return card;
            });

            for(let i = 0; i < count; i++) {
                try {
                    const imageUrl = await generateImageWithRetry(style.prompt);
                    const imageData = { src: imageUrl, style: style, id: generateUniqueId() };
                    const imageCard = createImageCard(imageData);
                    loadingCards[i].replaceWith(imageCard);
                    sounds.success();
                } catch (error) {
                    console.error('圖片生成失敗:', error);
                    loadingCards[i].innerHTML = `<p class="text-red-400 text-center p-4">哎呀，女神走丟了...<br>請稍後再試</p>`;
                }
                if (count > 1 && i < count - 1) {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            
            showMessage(`完成了 ${count} 次新的邂逅！`);

            isGenerating = false;
            generateOneBtn.disabled = false;
            generateFourBtn.disabled = false;
        }
        
        async function handleStoryGeneration(style) { /* ... same as previous version ... */ }
        async function handleTTSGeneration(text) { /* ... same as previous version ... */ }

        // --- Favorites & Slideshow Logic (REFACTORED & FIXED) ---
        function toggleFavorite(imageData, btn) {
            sounds.like();
            const index = favorites.findIndex(fav => fav.id === imageData.id);
            if (index > -1) {
                favorites.splice(index, 1);
                if(btn) btn.classList.remove('liked');
            } else {
                favorites.push(imageData);
                if(btn) btn.classList.add('liked');
            }
            saveFavorites();
            updateFavoritesCount();
        }

        function saveFavorites() {
            localStorage.setItem('goddessFavorites', JSON.stringify(favorites));
        }

        function loadFavorites() {
            const saved = localStorage.getItem('goddessFavorites');
            if (saved) {
                favorites = JSON.parse(saved);
                updateFavoritesCount();
            }
        }

        function updateFavoritesCount() {
            favoritesCountEl.textContent = favorites.length;
        }

        function openSlideshow() {
            if (favorites.length === 0) {
                showMessage('您的女神殿堂還是空的喔！');
                return;
            }
            sounds.open();
            currentSlideshowIndex = 0;
            renderThumbnails();
            showSlide(currentSlideshowIndex);
            slideshowModal.classList.add('show');
        }

        function navigateSlideshow(direction) {
            if (favorites.length <= 1) return;
            slideshowImage.classList.remove('visible');
            setTimeout(() => {
                currentSlideshowIndex = (currentSlideshowIndex + direction + favorites.length) % favorites.length;
                showSlide(currentSlideshowIndex);
            }, 250);
        }

        function showSlide(index) {
            if(index < 0 || index >= favorites.length) {
                slideshowModal.classList.remove('show');
                return;
            };
            currentSlideshowIndex = index;
            slideshowImage.src = favorites[index].src;
            slideshowImage.onload = () => slideshowImage.classList.add('visible');
            
            document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
                thumb.classList.toggle('active', i === index);
            });
            const activeThumb = document.querySelector(`.thumbnail[data-index='${index}']`);
            if(activeThumb) activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }

        function renderThumbnails() {
            thumbnailBar.innerHTML = '';
            const emptyState = document.getElementById('favorites-empty-state');
            if (favorites.length === 0) {
                if(emptyState) emptyState.style.display = 'flex';
                return;
            }
            if(emptyState) emptyState.style.display = 'none';

            favorites.forEach((fav, index) => {
                const thumb = document.createElement('img');
                thumb.src = fav.src;
                thumb.className = 'thumbnail';
                thumb.dataset.index = index;
                thumb.onclick = () => {
                    slideshowImage.classList.remove('visible');
                    setTimeout(() => showSlide(index), 250);
                };
                thumbnailBar.appendChild(thumb);
            });
        }

        function unfavoriteCurrentSlide() {
            if (favorites.length === 0) return;
            const currentFavorite = favorites[currentSlideshowIndex];
            
            toggleFavorite(currentFavorite, null);

            const cardInGallery = document.querySelector(`.image-card[data-id='${currentFavorite.id}']`);
            if (cardInGallery) {
                cardInGallery.querySelector('.like-btn').classList.remove('liked');
            }
            
            if (favorites.length === 0) {
                slideshowModal.classList.remove('show');
            } else {
                currentSlideshowIndex = Math.max(0, currentSlideshowIndex - 1);
                renderThumbnails();
                showSlide(currentSlideshowIndex);
            }
        }

        // --- API Call Logic ---
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        function getRandomItems(arr, count) {
            const shuffled = [...arr].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }
        
        async function generateImageWithRetry(prompt, retries = 3, delay = 1000) {
             const enhancedPrompt = `${prompt}, ${getRandomItems(randomKeywords.hair, 1)}, ${getRandomItems(randomKeywords.outfit, 1)}, ${getRandomItems(randomKeywords.setting, 1)}, ${getRandomItems(randomKeywords.artStyle, 1)}.`;
            const fullPrompt = `masterpiece, best quality, ultra-detailed, photorealistic, 8k, sharp focus, detailed beautiful face. ${enhancedPrompt} aspect ratio 2:3, raw style. Negative prompt: ugly, blurry, bad anatomy, disfigured, poorly drawn face, mutation, mutated, extra limb, dull eyes, bad hands, missing fingers, low quality, jpeg artifacts, text, watermark, signature, cartoon, 3d, deformed.`;

            for (let i = 0; i < retries; i++) {
                try {
                    return await callImageGenerationAPI(fullPrompt);
                } catch (error) {
                    if (error.message.includes("429")) {
                        console.warn("觸發速率限制，延長等待時間...");
                        await new Promise(res => setTimeout(res, 6000)); 
                    }
                    if (i === retries - 1) throw error;
                    console.log(`第 ${i + 1} 次重試...`);
                    await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
                }
            }
        }

        async function callImageGenerationAPI(userPrompt) {
            const selectedModel = document.getElementById('model-select').value;
            let apiUrl, payload;

            if (selectedModel === 'imagen-3') {
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                const [prompt, negative_prompt] = userPrompt.split("Negative prompt:");
                payload = {
                    instances: [{ prompt: prompt.trim(), negative_prompt: (negative_prompt || "").trim() }],
                    parameters: { "sampleCount": 1 }
                };
            } else { 
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-preview-image-generation:generateContent?key=${apiKey}`;
                const cleanedPrompt = userPrompt.split("Negative prompt:")[0].trim();
                payload = {
                    contents: [{ parts: [{ text: cleanedPrompt }] }],
                    generationConfig: { responseModalities: ['TEXT', 'IMAGE'] },
                };
            }

            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API 請求失敗，狀態碼：${response.status}. 回應: ${await response.text()}`);
            const result = await response.json();
            if (Object.keys(result).length === 0) throw new Error('API 回應了一個空物件');
            
            let base64Data;
            if (selectedModel === 'imagen-3') base64Data = result.predictions?.[0]?.bytesBase64Encoded;
            else base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

            if (base64Data) return `data:image/png;base64,${base64Data}`;
            else {
                console.error("API 回應中未找到圖片資料。 完整回應:", JSON.stringify(result, null, 2));
                throw new Error('API 回應中未找到有效的圖片資料。');
            }
        }

        async function callTextGenerationAPI(prompt) { /* ... same as previous version ... */ }
        async function callTTSAPI(text) { /* ... same as previous version ... */ }

        // --- Utility & Background Animation ---
        function base64ToArrayBuffer(base64) { /* ... same as previous version ... */ }
        function pcmToWav(pcmData, sampleRate) { /* ... same as previous version ... */ }
        const canvas = document.getElementById('background-canvas');
        const ctx = canvas.getContext('2d');
        let particlesArray;
        class Particle { /* ... same as previous version ... */ }
        function initParticles() { /* ... same as previous version ... */ }
        function animateParticles() { /* ... same as previous version ... */ }
        window.addEventListener('resize', () => { /* ... same as previous version ... */ });
        
        // --- Loading Animation ---
        const loadingCanvas = document.getElementById('loading-canvas');
        const loadingCtx = loadingCanvas.getContext('2d');
        let petals = [];
        function resizeLoadingCanvas() {
            loadingCanvas.width = window.innerWidth;
            loadingCanvas.height = window.innerHeight;
        }
        class Petal {
            constructor() {
                this.x = Math.random() * loadingCanvas.width;
                this.y = Math.random() * loadingCanvas.height * 2 - loadingCanvas.height;
                this.w = 20 + Math.random() * 15;
                this.h = 15 + Math.random() * 10;
                this.opacity = this.w / 35;
                this.xSpeed = 1 + Math.random();
                this.ySpeed = 0.5 + Math.random() * 0.5;
                this.flip = Math.random();
                this.flipSpeed = Math.random() * 0.03;
            }
            draw() {
                if (this.y > loadingCanvas.height || this.x > loadingCanvas.width) {
                    this.x = -this.w;
                    this.y = Math.random() * loadingCanvas.height * 2 - loadingCanvas.height;
                }
                loadingCtx.globalAlpha = this.opacity;
                loadingCtx.beginPath();
                loadingCtx.moveTo(this.x, this.y);
                loadingCtx.bezierCurveTo(this.x + this.w / 2, this.y - this.h / 2, this.x + this.w, this.y, this.x + this.w / 2, this.y + this.h / 2);
                loadingCtx.closePath();
                const grad = loadingCtx.createLinearGradient(this.x, this.y, this.x + this.w, this.y + this.h);
                grad.addColorStop(0, 'rgba(255, 192, 203, 0.8)'); // Pink
                grad.addColorStop(1, 'rgba(236, 72, 153, 0.5)'); // Deeper Pink
                loadingCtx.fillStyle = grad;
                loadingCtx.fill();
            }
            animate() {
                this.x += this.xSpeed;
                this.y += this.ySpeed;
                this.flip += this.flipSpeed;
                this.draw();
            }
        }

        function animateLoading() {
            loadingCtx.clearRect(0, 0, loadingCanvas.width, loadingCanvas.height);
            petals.forEach(petal => petal.animate());
            requestAnimationFrame(animateLoading);
        }

        // --- Initialization ---
        document.body.addEventListener('click', () => { Tone.start(); }, { once: true });
        window.onload = () => {
            initializeUI();
            initParticles();
            animateParticles();

            // Start loading animation
            resizeLoadingCanvas();
            for(let i = 0; i < 30; i++) { petals.push(new Petal()); }
            animateLoading();
        };
    </script>

</body>
</html>
